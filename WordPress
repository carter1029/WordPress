#!/bin/bash

# 检测Linux发行版
if [ -f /etc/lsb-release ]; then
    DISTRO="ubuntu"
elif [ -f /etc/redhat-release ]; then
    DISTRO="centos"
elif [ -f /etc/debian_version ]; then
    DISTRO="debian"
else
    echo "不支持的发行版"
    exit 1
fi

install_dir="/var/www/html"
db_name="wp$(date +%s)"
db_user="$db_name"
db_password=$(date +%s | sha256sum | head -c 10)
mysqlrootpass=$(date +%s | sha256sum | head -c 10)

# 根据Linux发行版安装必要的软件包
case "$DISTRO" in
    "ubuntu"|"debian")
        apt-get update -y
        apt-get install -y nginx mysql-server php-fpm php-mysql lynx php-cli
        ;;
    "centos")
        yum -y update
        yum -y install epel-release
        yum -y install nginx mariadb-server php-fpm php-mysql lynx php-cli
        ;;
    *)
        echo "不支持的发行版"
        exit 1
        ;;
esac

# 启动Nginx和MySQL
systemctl enable nginx
systemctl start nginx
systemctl enable mysql
systemctl start mysql

# 设置MySQL root密码
mysql -e "USE mysql;"
mysql -e "ALTER USER 'root'@'localhost' IDENTIFIED WITH 'mysql_native_password' BY '$mysqlrootpass';"
mysql -e "FLUSH PRIVILEGES;"
cat > /root/.my.cnf <<EOF
[client]
user=root
password=$mysqlrootpass
EOF
chmod 640 /root/.my.cnf

# 安装PHP并配置Nginx支持PHP
apt-get install -y php || yum install -y php
sed -i 's/;cgi.fix_pathinfo=1/cgi.fix_pathinfo=0/' /etc/php/*/fpm/php.ini || sed -i 's/;cgi.fix_pathinfo=1/cgi.fix_pathinfo=0/' /etc/php.ini

systemctl restart nginx

# 下载并解压最新的WordPress包
if [ ! -f /tmp/latest.tar.gz ]; then
    echo "正在下载WordPress"
    wget -O /tmp/latest.tar.gz http://wordpress.org/latest.tar.gz
fi

tar -C $install_dir -zxf /tmp/latest.tar.gz --strip-components=1
chown nginx:nginx $install_dir -R

# 检查wp-config-sample.php是否存在
if [ ! -f "$install_dir/wp-config-sample.php" ]; then
    echo "wp-config-sample.php 不存在"
    exit 1
fi

# 创建wp-config.php文件并设置数据库凭证
cp $install_dir/wp-config-sample.php $install_dir/wp-config.php

sed -i "s/database_name_here/$db_name/g" $install_dir/wp-config.php
sed -i "s/username_here/$db_user/g" $install_dir/wp-config.php
sed -i "s/password_here/$db_password/g" $install_dir/wp-config.php

cat << EOF >> $install_dir/wp-config.php
define('FS_METHOD', 'direct');
EOF

# 生成WordPress安全密钥（Salts）
wget -O - https://api.wordpress.org/secret-key/1.1/salt/ >> $install_dir/wp-config.php

mysql -u root -e "CREATE DATABASE $db_name;"
mysql -u root -e "CREATE USER '$db_name'@'localhost' IDENTIFIED WITH 'mysql_native_password' BY '$db_password';"
mysql -u root -e "GRANT ALL PRIVILEGES ON $db_name.* TO '$db_user'@'localhost';"

# 显示生成的密码到日志文件
echo "数据库名称：$db_name"
echo "数据库用户：$db_user"
echo "数据库密码：$db_password"
echo "MySQL root密码：$mysqlrootpass"
